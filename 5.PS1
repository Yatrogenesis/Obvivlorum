# 05_middleware_e_interfaz.ps1
# Ejecutar con PowerShell como administrador

# Verificar si se estÃ¡ ejecutando como administrador
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "âŒ Este script debe ejecutarse como administrador." -ForegroundColor Red
    Write-Host "   Cierra esta ventana y ejecuta PowerShell como administrador." -ForegroundColor Yellow
    pause
    exit 1
}

Write-Host "=== Simbiosis: Paso 5 - Middleware simbiÃ³tico + Interfaz GPT ===" -ForegroundColor Cyan

# Verificar instalaciÃ³n previa de TinyLLaMA
$llamaExists = wsl -d kali-linux -- bash -c "
    if [ -f ~/obvlivorum_simbiosis/llama.cpp/main ] && [ -f ~/obvlivorum_simbiosis/llama.cpp/models/tinyllama-1.1b-chat.Q4_K_M.gguf ]; then
        echo 'OK'
    else
        echo 'FALTA'
    fi
"

if ($llamaExists -ne "OK") {
    Write-Host "âŒ No se encontrÃ³ TinyLLaMA instalado correctamente." -ForegroundColor Red
    Write-Host "   Ejecuta primero el Script 4." -ForegroundColor Yellow
    pause
    exit 1
}

# Verificar mÃ³dulo holomem
$holomemExists = wsl -d kali-linux -- bash -c "
    if [ -f ~/obvlivorum_simbiosis/holomem/holomem-util ] && lsmod | grep -q holomem; then
        echo 'OK'
    else
        echo 'FALTA'
    fi
"

if ($holomemExists -ne "OK") {
    Write-Host "âŒ El mÃ³dulo holomem no estÃ¡ cargado o no se compilÃ³ correctamente." -ForegroundColor Red
    Write-Host "   Verifica los Scripts 2 y 3." -ForegroundColor Yellow
    pause
    exit 1
}

# Instalar dependencias para el middleware
Write-Host "ðŸ”„ Instalando dependencias para el middleware..." -ForegroundColor Yellow
$installResult = wsl -d kali-linux -- bash -c "
    sudo apt update &&
    sudo apt install -y python3 python3-pip python3-venv espeak ffmpeg python3-pyaudio portaudio19-dev
"

if (-not $?) {
    Write-Host "âŒ Error al instalar dependencias necesarias." -ForegroundColor Red
    Write-Host $installResult -ForegroundColor Red
    pause
    exit 1
}

# Crear entorno virtual Python
Write-Host "ðŸ”„ Creando entorno virtual Python..." -ForegroundColor Yellow
$venvResult = wsl -d kali-linux -- bash -c "
    cd ~/obvlivorum_simbiosis &&
    python3 -m venv simbiox &&
    source simbiox/bin/activate &&
    pip install -U pip wheel setuptools &&
    pip install pyttsx3 SpeechRecognition sounddevice scipy openai-whisper PyAudio
"

if (-not $?) {
    Write-Host "âŒ Error al crear entorno virtual o instalar paquetes Python." -ForegroundColor Red
    Write-Host $venvResult -ForegroundColor Red
    pause
    exit 1
}

# Crear script Python mejorado
Write-Host "ðŸ”„ Creando script de interfaz simbiÃ³tica..." -ForegroundColor Yellow

$pythonScript = @'
#!/usr/bin/env python3
import os
import subprocess
import sys
import time
import signal
import threading
import pyttsx3
import traceback

# Rutas absolutas
MODEL_PATH = os.path.expanduser("~/obvlivorum_simbiosis/llama.cpp/models/tinyllama-1.1b-chat.Q4_K_M.gguf")
LLAMA_PATH = os.path.expanduser("~/obvlivorum_simbiosis/llama.cpp/main")
HOLOMEM_UTIL = os.path.expanduser("~/obvlivorum_simbiosis/holomem/holomem-util")

# ConfiguraciÃ³n TTS
try:
    engine = pyttsx3.init()
    engine.setProperty("rate", 145)
    engine.setProperty("volume", 1.0)
    TTS_DISPONIBLE = True
except Exception as e:
    print(f"ADVERTENCIA: No se pudo inicializar el motor TTS: {e}")
    TTS_DISPONIBLE = False

# FunciÃ³n para verificar componentes
def verificar_componentes():
    componentes_ok = True
    
    # Verificar TinyLLaMA
    if not os.path.isfile(LLAMA_PATH):
        print(f"âŒ ERROR: Ejecutable de llama.cpp no encontrado en: {LLAMA_PATH}")
        componentes_ok = False
    
    if not os.path.isfile(MODEL_PATH):
        print(f"âŒ ERROR: Modelo TinyLLaMA no encontrado en: {MODEL_PATH}")
        componentes_ok = False
    
    # Verificar holomem
    try:
        result = subprocess.run(["lsmod"], stdout=subprocess.PIPE, text=True)
        if "holomem" not in result.stdout:
            print("âŒ ERROR: MÃ³dulo holomem no cargado en el kernel")
            componentes_ok = False
    except Exception as e:
        print(f"âŒ ERROR al verificar mÃ³dulo holomem: {e}")
        componentes_ok = False
    
    # Verificar holomem-util
    if not os.path.isfile(HOLOMEM_UTIL):
        print(f"âŒ ERROR: Utilidad holomem-util no encontrada en: {HOLOMEM_UTIL}")
        componentes_ok = False
    
    return componentes_ok

# FunciÃ³n para manejar interrupciÃ³n
def signal_handler(sig, frame):
    print("\nCerrando Simbiosis GPT CLI...")
    sys.exit(0)

# Registrar manejador de seÃ±al para Ctrl+C
signal.signal(signal.SIGINT, signal_handler)

# Clase para la interfaz simbiÃ³tica
class SimbioteInterface:
    def __init__(self):
        self.history = []
        self.context = "Eres un asistente de IA simbiÃ³tico que responde de manera concisa y Ãºtil."
    
    def generar_respuesta(self, prompt):
        try:
            # Construir prompt con contexto y historia limitada
            full_prompt = self.context + "\n\n"
            
            # AÃ±adir Ãºltimas 3 interacciones de historia si existen
            for i in range(max(0, len(self.history)-3), len(self.history)):
                full_prompt += f"Usuario: {self.history[i][0]}\nIA: {self.history[i][1]}\n\n"
            
            # AÃ±adir la pregunta actual
            full_prompt += f"Usuario: {prompt}\nIA:"
            
            # Lanzar la interfaz
Write-Host "ðŸš€ Lanzando entorno simbiÃ³tico..." -ForegroundColor Green
Write-Host "âœ… Presiona Ctrl+C para salir cuando hayas terminado." -ForegroundColor Green

# Limpiar pantalla para una mejor experiencia
Clear-Host

# Imprimir banner
Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
Write-Host "â•‘  ðŸ§  Simbiosis GPT CLI - Interfaz Neural   â•‘" -ForegroundColor Cyan
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

# Ejecutar la interfaz
wsl -d kali-linux -- bash -c "
    cd ~/obvlivorum_simbiosis &&
    source simbiox/bin/activate &&
    python3 simbiosis_cli.py
"

# Verificar resultado
if (-not $?) {
    Write-Host "âŒ Error al ejecutar la interfaz simbiÃ³tica." -ForegroundColor Red
    Write-Host "   Revisa los mensajes de error y verifica los componentes." -ForegroundColor Yellow
    pause
    exit 1
}

Write-Host "âœ… SesiÃ³n simbiÃ³tica finalizada." -ForegroundColor Greenlamar a TinyLLaMA
            print("â³ Procesando con TinyLLaMA...")
            cmd = [
                LLAMA_PATH,
                "-m", MODEL_PATH,
                "-p", full_prompt,
                "-n", "256",
                "--temp", "0.7",
                "--no-display-prompt"
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode != 0:
                print(f"âš ï¸ Error al ejecutar TinyLLaMA: {result.stderr}")
                return "Lo siento, ocurriÃ³ un error al procesar tu solicitud."
            
            # Limpiar y extraer la respuesta
            response = result.stdout.strip()
            
            # Limitar longitud y eliminar posible texto generado extra
            if len(response) > 500:
                response = response[:500] + "..."
            
            # Almacenar en historial
            self.history.append((prompt, response))
            
            # Guardar en holomem
            self.guardar_en_holomem(prompt, response)
            
            return response
        
        except Exception as e:
            print(f"âŒ Error al generar respuesta: {e}")
            traceback.print_exc()
            return "Lo siento, ocurriÃ³ un error inesperado."
    
    def guardar_en_holomem(self, prompt, response):
        try:
            # Guardar prompt del usuario
            with open("/tmp/user_prompt.txt", "w") as f:
                f.write(prompt)
            
            # Guardar respuesta de la IA
            with open("/tmp/ai_response.txt", "w") as f:
                f.write(response)
            
            # Almacenar en holomem
            subprocess.run([
                HOLOMEM_UTIL, "store", "/tmp/user_prompt.txt", "0", "Usuario-Prompt"
            ], stderr=subprocess.DEVNULL)
            
            subprocess.run([
                HOLOMEM_UTIL, "store", "/tmp/ai_response.txt", "1", "IA-Respuesta"
            ], stderr=subprocess.DEVNULL)
            
        except Exception as e:
            print(f"âš ï¸ Error al guardar en holomem: {e}")
    
    def hablar(self, texto):
        if not TTS_DISPONIBLE:
            return
        
        try:
            # Iniciar thread para no bloquear
            def speak_thread():
                engine.say(texto)
                engine.runAndWait()
            
            thread = threading.Thread(target=speak_thread)
            thread.daemon = True
            thread.start()
            
        except Exception as e:
            print(f"âš ï¸ Error en TTS: {e}")

# FunciÃ³n principal
def main():
    # Banner
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘  ðŸ§  Simbiosis GPT CLI - Interfaz Neural   â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    
    # Verificar componentes
    if not verificar_componentes():
        print("\nâŒ Algunos componentes crÃ­ticos no estÃ¡n disponibles.")
        print("   Verifica que hayas ejecutado correctamente los scripts 1-4.")
        return 1
    
    # Inicializar interfaz
    interface = SimbioteInterface()
    
    print("\nâœ… Todos los sistemas funcionando. Escribe 'salir' para terminar.")
    print("ðŸ”„ Puedes hacer preguntas o pedir tareas al sistema simbiÃ³tico.\n")
    
    # Bucle principal
    while True:
        try:
            # Obtener entrada de usuario
            prompt = input("ðŸ‘¤ TÃº > ").strip()
            
            # Verificar comando de salida
            if prompt.lower() in ["salir", "exit", "quit", "q"]:
                print("âœ… Cerrando sistema simbiÃ³tico...")
                break
            
            # Si la entrada estÃ¡ vacÃ­a, continuar
            if not prompt:
                continue
            
            # Procesar y generar respuesta
            response = interface.generar_respuesta(prompt)
            
            # Mostrar respuesta
            print("\nðŸ¤– IA > " + response + "\n")
            
            # Reproducir respuesta (si TTS estÃ¡ disponible)
            interface.hablar(response)
            
        except KeyboardInterrupt:
            print("\nâœ… Cerrando sistema simbiÃ³tico...")
            break
        except Exception as e:
            print(f"\nâŒ Error inesperado: {e}")
            traceback.print_exc()
    
    return 0

if __name__ == "__main__":
    sys.exit(main())
'@

# Escribir script Python
wsl -d kali-linux -- bash -c "cat > ~/obvlivorum_simbiosis/simbiosis_cli.py << 'EOF'
$pythonScript
EOF
chmod +x ~/obvlivorum_simbiosis/simbiosis_cli.py
"

if (-not $?) {
    Write-Host "âŒ Error al crear el script de interfaz." -ForegroundColor Red
    pause
    exit 1
}

Write-Host "âœ… Middleware e interfaz creados correctamente." -ForegroundColor Green
Write-Host "âœ… Paso 5 completado. Ejecuta el Script 6 para lanzar el entorno simbiÃ³tico." -ForegroundColor Green